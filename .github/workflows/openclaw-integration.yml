name: OpenClaw Discord Integration

on:
  pull_request:
    types: [opened, synchronize, closed]
  pull_request_review:
    types: [submitted]
  workflow_run:
    workflows: ["Auto-Integrate Templates"]
    types: [completed]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Determine the message based on event
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            if [ "${{ github.event.action }}" == "opened" ]; then
              MESSAGE="ðŸš€ **New PR Created**\n\n**Title**: ${{ github.event.pull_request.title }}\n**Branch**: \`${{ github.event.pull_request.head.ref }}\`\n**URL**: ${{ github.event.pull_request.html_url }}\n\nðŸ¤– CodeRabbit is reviewing..."
            elif [ "${{ github.event.action }}" == "closed" ]; then
              if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
                MESSAGE="âœ… **PR Merged!**\n\n**Title**: ${{ github.event.pull_request.title }}\n\nAll done! Time to relax ðŸ˜Ž"
              else
                MESSAGE="âŒ **PR Closed**\n\n**Title**: ${{ github.event.pull_request.title }}"
              fi
            fi
          elif [ "${{ github.event_name }}" == "pull_request_review" ]; then
            if [ "${{ github.event.review.state }}" == "approved" ]; then
              MESSAGE="âœ… **CodeRabbit Approved!**\n\n**PR**: ${{ github.event.pull_request.title }}\n\nðŸ¤– Auto-integration starting..."
            elif [ "${{ github.event.review.state }}" == "changes_requested" ]; then
              MESSAGE="âš ï¸ **CodeRabbit Requested Changes**\n\n**PR**: ${{ github.event.pull_request.title }}\n\nCheck the review comments!"
            fi
          elif [ "${{ github.event_name }}" == "workflow_run" ]; then
            if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
              MESSAGE="ðŸŽ‰ **Auto-Integration Complete!**\n\nTemplates are integrated and ready to merge!\n\nType \`!merge\` to merge the PR"
            else
              MESSAGE="âŒ **Auto-Integration Failed**\n\nCheck the workflow logs"
            fi
          fi
          
          # Send to Discord
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"$MESSAGE\"}" \
               $DISCORD_WEBHOOK

  # Optional: Auto-merge if all checks pass
  auto-merge:
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Auto-merge PR
        uses: actions/github-script@v7
        with:
          script: |
            // Get the PR associated with this workflow run
            const pr = context.payload.workflow_run.pull_requests[0];
            if (!pr) return;
            
            // Check if all checks passed
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            const allPassed = checks.check_runs.every(check => 
              check.conclusion === 'success' || check.conclusion === 'skipped'
            );
            
            if (allPassed) {
              // Merge the PR
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'squash',
                commit_title: `${pr.title} (#${pr.number})`,
                commit_message: 'Auto-merged after successful checks âœ…'
              });
              
              console.log('âœ… PR auto-merged!');
            }
